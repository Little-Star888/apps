# --- 基础信息 / Basic Information ---
local app_id="dnsmgr"
local app_name="彩虹聚合DNS管理系统"
local app_text="彩虹聚合DNS一站式管理阿里云、腾讯云、CF等多个平台的域名解析"
local app_url="https://github.com/netcccyun/dnsmgr"
local docker_name="dnsmgr"
local docker_port="8204"
local app_size="1"

# --- 核心逻辑 / Core Logic ---
docker_app_install() {
    # 1. 环境准备
    # 镜像已内置 PHP8.0+ 和 ThinkPHP 所需的伪静态配置
    local base_dir="/home/docker/dnsmgr"
    mkdir -p "$base_dir/www" && cd "$base_dir"

    # 2. 写入 Docker Compose
    # 挂载 /app/www 目录以实现程序文件和数据库（如果是 SQLite）的持久化
    cat <<EOF > docker-compose.yml
version: '3'
services:
  dnsmgr:
    image: netcccyun/dnsmgr:latest
    container_name: ${docker_name}
    restart: always
    ports:
      - "${docker_port}:80"
    volumes:
      - "${base_dir}/www:/app/www"
    environment:
      - TZ=Asia/Shanghai
EOF

    # 3. 预设权限
    # ThinkPHP 程序需要对 runtime 和 public 目录有写入权限
    chmod -R 777 "$base_dir/www"

    # 4. 启动容器
    echo "正在拉取镜像并部署彩虹 DNS 管理系统..."
    docker compose up -d

    echo "部署完成！"
    echo "请访问 http://服务器IP:${docker_port} 按照引导完成数据库配置和安装。"
    
    check_docker_app_ip
}

docker_app_update() {
    cd /home/docker/dnsmgr
    echo "开始检查更新..."
    # 按照文档说明，重新拉取镜像即可完成程序覆盖更新
    docker compose pull
    docker compose up -d
    echo "更新完成 / Update Complete"
}

docker_app_uninstall() {
    cd /home/docker/dnsmgr
    # 卸载前确认是否保留数据（根据你的需求，这里默认彻底物理删除）
    docker compose down --rmi all
    rm -rf /home/docker/dnsmgr
    echo "卸载完成 / Uninstall Complete"
}

# --- 注册 / Registration ---
docker_app_plus
